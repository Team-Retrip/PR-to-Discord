name: 'PR to Discord'
author: 'Team-Retrip'
description: 'sends PR notifications to Discord.'
branding:
  icon: 'award'
  color: 'blue'

inputs:
  discord_webhook_url:
    description: 'webhook URL of a Discord channel.'
    required: true
  pull_request:
    description: 'Pull request json.'
    required: false
    default: ${{ toJson(github.event.pull_request) }}

runs:
  using: 'composite'
  steps:
    - shell: bash
      env:
        BODY: ${{ toJson(fromJson(inputs.pull_request).body) }}
        USERNAME: ${{ toJson(fromJson(inputs.pull_request).user.login) }}
        AVATAR_URL: ${{ toJson(fromJson(inputs.pull_request).user.avatar_url) }}
        TITLE: ${{ toJson(fromJson(inputs.pull_request).title) }}
        URL: ${{ toJson(fromJson(inputs.pull_request).html_url) }}
        ASSIGNEES: ${{ toJson(fromJson(inputs.pull_request).assignees) }}
        LABELS: ${{ toJson(fromJson(inputs.pull_request).labels) }}
      run: |
        PROBLEM=$(
          echo $BODY |
          grep -Pio 'http[\w\:\/\.\-\?\=\&]+' |
          head -1 ||
          echo "$URL"
        );
        
        TITLE=$(
          echo $TITLE |
          tr -d '"'
        );
        
        MENTIONS=$(
          echo $ASSIGNEES | 
          jq -r '.[] | "@"+.login' | 
          paste -sd " "
        );
        if [ -z "$MENTIONS" ]; then
          MENTIONS="ë‹´ë‹¹ìžê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        fi

        LABELS_LIST=$(
          echo $LABELS |
          jq -r '.[] | .name' |
          paste -sd ", "
        );
        if [ -z "$LABELS_LIST" ]; then
          LABELS_LIST="ì—†ìŒ"
        fi

        # í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œ í¬ë§· ë³€ê²½
        DATE_FORMATTED_KST=$(TZ='Asia/Seoul' date +'%Y-%m-%d %H:%M:%S')
        
        # í•œêµ­ ì‹œê°„ì„ UTCë¡œ ë³€í™˜
        DATE_FORMATTED_UTC=$(date --utc +%Y-%m-%dT%H:%M:%SZ)

        echo "PROBLEM=$PROBLEM" >> $GITHUB_ENV;
        echo "USERNAME=$USERNAME" >> $GITHUB_ENV;
        echo "AVATAR_URL=$AVATAR_URL" >> $GITHUB_ENV;
        echo "TITLE=$TITLE" >> $GITHUB_ENV;
        echo "URL=$URL" >> $GITHUB_ENV;
        echo "MENTIONS=$MENTIONS" >> $GITHUB_ENV;
        echo "LABELS=$LABELS_LIST" >> $GITHUB_ENV;
        echo "TIMESTAMP_KST=$DATE_FORMATTED_KST" >> $GITHUB_ENV;
        echo "TIMESTAMP_UTC=$DATE_FORMATTED_UTC" >> $GITHUB_ENV;

    - shell: bash
      env:
        DATA: |
          {
            "username": ${{ env.USERNAME }},
            "avatar_url": ${{ env.AVATAR_URL }},
            "embeds": [
              {
                "title": "ðŸ“Œ Pull Request: ${{ env.TITLE }}",
                "description": "ìƒˆë¡œìš´ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì•„ëž˜ì˜ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.",
                "url": ${{ env.URL }},
                "color": 3066993,
                "fields": [
                  {
                    "name": "ðŸ”— Pull Request URL",
                    "value": ${{ env.PROBLEM }},
                    "inline": false
                  },
                  {
                    "name": "ðŸ‘¤ ìž‘ì„±ìž",
                    "value": ${{ env.USERNAME }},
                    "inline": true
                  },
                  {
                    "name": "ðŸ“… ìƒì„± ë‚ ì§œ",
                    "value": "${{ env.TIMESTAMP_KST }}",
                    "inline": true
                  },
                  {
                    "name": "ðŸ› ï¸ ë‹´ë‹¹ìž",
                    "value": "${{ env.MENTIONS }}",
                    "inline": false
                  },
                  {
                    "name": "ðŸ·ï¸ ë¼ë²¨",
                    "value": "${{ env.LABELS }}",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "PR Notification Bot â€¢ Team Retrip"
                },
                "timestamp": "${{ env.TIMESTAMP_UTC }}"
              }
            ]
          }
      run: >
        curl -X
        POST -H 'Content-type:application/json'
        -d "$DATA"
        ${{ inputs.discord_webhook_url }}
